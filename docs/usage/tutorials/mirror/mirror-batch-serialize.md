# Mirror Batch-Serialize Tutorial

## Batch-Serialize

The `ace-dt mirror batch-serialize` command serializes a list of mirror artifacts specified in a CSV file (BATCH-LIST) into tar files stored in a local directory (SYNC-DIRECTORY). It ensures no duplicate blobs are serialized by using a tracker file (SYNC-DIRECTORY/recordKeeping.csv by default) to keep track of previously serialized artifacts. Only the latest version of an artifact is serialized if duplicates exist in the BATCH-LIST. Additional options allow for compression, manifest generation, and overriding the tracker file name.

### Batch-Serialize Usage

`ace-dt mirror batch-serialize BATCH-LIST SYNC-DIRECTORY`

### When is Batch-Serialize Useful?

Use `ace-dt mirror batch-serialize` when a workflow requires frequent copying of mirror artifacts (especially across an air gap) to minimize the amount of duplicate and unnecessary blob copies. The `batch-serialize` command will refer to the tracker file and only copy the blobs that have not been copied in previous iterations.

### Tutorial

#### Prerequisites

- User must have access to a registry (remotely or [creating one locally](../mirror.md#establish-local-oci-repositories)).

- User must have access to 2 mirror artifacts that share an image/multiple images. To generate an example pair of artifacts, create a sources-1.list and sources-2.list and gather them into a mirror artifact.

First, create a sources-1.list file:

```sh
echo -e "docker.io/library/registry:2.8.3\ndocker.io/grafana/grafana:10.4.1" > sources-1.list
```

This will create a sources-1.list file that looks like this:

```txt
docker.io/library/registry:2.8.3
docker.io/grafana/grafana:10.4.1
```

Gather the **sources-1.list** amd64 images to *localhost:5000/gather:sources1*:

```sh
ace-dt mirror gather sources-1.list localhost:5000/gather:sources1 --platforms=linux/amd64

```

Create a sources-2.list file that shares some of the same images as sources-1.list:

```sh
echo -e "docker.io/grafana/grafana:10.4.1\ndocker.io/library/caddy:2.7.6" > sources-2.list
```

Gather the **sources-2.list** images to *localhost:5000/gather:sources2*:

```txt
docker.io/grafana/grafana:10.4.1
docker.io/library/caddy:2.7.6
```

```sh
ace-dt mirror gather sources-2.list localhost:5000/gather:sources2 --platforms=linux/amd64
```

For more detail on the prerequisite steps above, visit the [Creating a sources.list file](../mirror.md#prepare-a-sourceslist-file) and [Gathering Artifacts](../mirror.md#populate-the-low-side-repository) tutorials.

#### Batch-Serialize the First Artifact

First, create and save the `BATCH-LIST`. This is a CSV file of mirror artifacts (generated by ace-dt mirror gather) that will be serialized to tar and is the main input for the `ace-dt mirror batch-serialize` command.

```sh
echo -e "name,artifact\ntools,localhost:5000/gather:sources1" > batch.csv
```

This will create the following CSV file:

```csv
name, artifact
tools, localhost:5000/gather:sources1
```

The artifact name is an identifier for the mirror artifact. Each time the artifact "upgrades" (images within change versions and the artifact needs to be regenerated), the name stays the same in the batch csv file and only the reference/tag of the artifact changes.

Next, create a `SYNC-DIRECTORY`. This directory is where the serialized files will be stored and where ace-dt will generate the **tracker file**.

```sh
mkdir ./sync
```

Then run the `batch-serialize` command to create a tar file:

`ace-dt mirror batch-serialize batch.csv ./sync`

Optionally, the command can be run with compression options to achieve zst or gzip files:

`ace-dt mirror batch-serialize batch.csv ./sync --compression=zstd`

or

`ace-dt mirror batch-serialize batch.csv ./sync --compression=gzip`

Running the batch-serialize command will serialize (and compress if passed) all of the blobs into a file that is created based on the artifacts name in the batch file:

```sh
$ ls ./sync
000001-tools.tar   record-keeping.csv
```

The `record-keeping.csv` file is generated by `ace-dt` and should remain in the sync directory in order for future batch-serialization commands to properly skip over previously serialized blobs. Wiping the `record-keeping.csv` file should only be done if all artifacts and their associated blobs in the `batch.csv` file need to be re-serialized. This file keeps track of the exact digest and mirror artifact that is contained in each file:

```sh
$ cat sync/record-keeping.csv 
sync_name,artifact,digest
000001-tools.tar,localhost:5000/gather:sources1,sha256:3f6d73a22766492325e12b9fffdcfe0599186c823bf190c04ee597bfe15584b8
```

#### Batch-Serialize the Second Artifact

Now we can serialize the second artifact in the same manner which we serialized the first. Subsequent `mirror batch-serialize` commands involve only editing the `BATCH-FILE` before re-running the command. The end goal here is to recognize that the shared blobs between localhost:5000/gather:sources1 and localhost:5000/gather:sources2 will not exist in the second tar file we generate:

First, we append our second artifact (or overwrite) our `batch.csv` file. Notice that the name of the artifact is the same because this is the second version of the artifact:

```sh
echo tools,localhost:5000/gather:sources2 >> batch.csv
```

Re-run the `batch-serialize` command to create a tar file (using compression options as needed):

`ace-dt mirror batch-serialize batch.csv ./sync`

After completion, a new tar file exists in the `SYNC-DIRECTORY`:

```sh
$ ls ./sync
000001-tools.tar   000002-tools.tar   record-keeping.csv
```

Also, a new entry exists in the `record-keeping.csv` file:

```csv
000001-tools.tar,localhost:5000/gather:sources1,sha256:3f6d73a22766492325e12b9fffdcfe0599186c823bf190c04ee597bfe15584b8
000002-tools.tar,localhost:5000/gather:sources2,sha256:825bfc9687552cc2afdc940581c0615409e269a1f044e2bacbad6a81d21e9ee4
```

#### Validation of the Batch-Serialize command

Immediately we can see that the sizes of the two tar files are very different. We expect that `000002-tools.tar` file will be much smaller than `000001-tools.tar` because its initial artifact contained many of the same blobs. Looking at the `SYNC-DIRECTORY`, we can see that this is true:

```sh
$ ls -lh
total 141M
-rw-rw-r-- 1 ebarkett ebarkett 123M Jan 27 16:16 000001-tools.tar
-rw-rw-r-- 1 ebarkett ebarkett  18M Jan 27 16:17 000002-tools.tar
-rw-rw-r-- 1 ebarkett ebarkett  266 Jan 27 16:17 record-keeping.csv
```

The second file is 105M smaller than the first! Why does this matter? Because if you were to deserialize the first artifact over some air gap and then scatter the images to their respective locations in the air gapped registries, you will have to move all 123M of data. Using batch-serialize, `ace-dt` can keep track of blobs that were archived or moved and the subsequent operation for the second file would only involve moving 18M of data. When dealing with larger artifacts that are many GB, using `ace-dt batch serialize` can save a substantial amount of time.

The ASCE Data Tool also contains a handy command for quickly visualizing the blobs that are contained in a manifest. Using this command, we can see exactly what blobs are in the `docker.io/grafana/grafana:10.4.1` linux/amd64 image:

```sh
$ ace-dt oci tree docker.io/grafana/grafana:10.4.1@sha256:8b10c3744b8fede79af784d967911691d0e2d6e505512d1466ae1dbcaf745033

Successors of
[2.4 kB] application/vnd.docker.distribution.manifest.v2+json 8b10c3744b8f 
üìú manifest 
‚îÇ  ‚î£‚îÅ üéõ  config[7.2 kB] application/vnd.docker.container.image.v1+json ccb72d0beb64 
‚îÇ  ‚îó‚îÅ ü•û layers
‚îÇ        ‚î£‚îÅ [3.4 MB] application/vnd.docker.image.rootfs.diff.tar.gzip 4abcf2066143 
‚îÇ        ‚î£‚îÅ [ 139 B] application/vnd.docker.image.rootfs.diff.tar.gzip b56d275ef537 
‚îÇ        ‚î£‚îÅ [3.2 MB] application/vnd.docker.image.rootfs.diff.tar.gzip bf064887a9c7 
‚îÇ        ‚î£‚îÅ [4.3 MB] application/vnd.docker.image.rootfs.diff.tar.gzip b706854df8e9 
‚îÇ        ‚î£‚îÅ [ 47 kB] application/vnd.docker.image.rootfs.diff.tar.gzip 69ef7069416c 
‚îÇ        ‚î£‚îÅ [ 23 kB] application/vnd.docker.image.rootfs.diff.tar.gzip 04edff225a62 
‚îÇ        ‚î£‚îÅ [ 58 MB] application/vnd.docker.image.rootfs.diff.tar.gzip 3e634c55be4d 
‚îÇ        ‚î£‚îÅ [ 50 MB] application/vnd.docker.image.rootfs.diff.tar.gzip c8f00c165a37 
‚îÇ        ‚î£‚îÅ [ 12 kB] application/vnd.docker.image.rootfs.diff.tar.gzip 481ee4744cbf 
‚îÇ        ‚îó‚îÅ [1.2 kB] application/vnd.docker.image.rootfs.diff.tar.gzip 1bcf66605cd1 
‚îî‚ï¥ 119 MB total
Total: 119 MB (119 MB deduplicated)
```

Assuming the `ace-dt batch serialize` command worked, we expect to find the above blobs in the first tar file but not the second.

The tar files themselves can be inspected to observe that the second tar file does not contain any of the layers in the shared `docker.io/grafana/grafana:10.4.1` linux/amd64 image:

```sh
$ tar tvf 000001-tools.tar 
-rw-rw-rw- 0/0              30 1969-12-31 19:00 oci-layout
-rw-rw-rw- 0/0             580 1969-12-31 19:00 index.json
drwxrwxrwx 0/0               0 1969-12-31 19:00 blobs
drwxrwxrwx 0/0               0 1969-12-31 19:00 blobs/sha256
-rw-rw-rw- 0/0           10603 1969-12-31 19:00 blobs/sha256/7c56c1c5c912bc376b9aad8cde4a0b3545061cc7ae6300509d1f3f8f15b3ddc7
-rw-rw-rw- 0/0            2416 1969-12-31 19:00 blobs/sha256/8b10c3744b8fede79af784d967911691d0e2d6e505512d1466ae1dbcaf745033
-rw-rw-rw- 0/0            7175 1969-12-31 19:00 blobs/sha256/ccb72d0beb647169c9190eb6b696dfb69f406e64b61ec7161f4f2e1e37dba6db
-rw-rw-rw- 0/0         3408729 1969-12-31 19:00 blobs/sha256/4abcf20661432fb2d719aaf90656f55c287f8ca915dc1c92ec14ff61e67fbaf8
-rw-rw-rw- 0/0             139 1969-12-31 19:00 blobs/sha256/b56d275ef5376c1cbd0080b208aee4531ea642d76504ca6c1d7ff7a2d2717682
-rw-rw-rw- 0/0         3160040 1969-12-31 19:00 blobs/sha256/bf064887a9c71ba7dc8f048b37c787b1ee93c488e656b633fab4831ed05b6ab7
-rw-rw-rw- 0/0         4333096 1969-12-31 19:00 blobs/sha256/b706854df8e94f05b189985822fcf198799de737ab7bccc1f0b52a4bb6f4040c
-rw-rw-rw- 0/0           47116 1969-12-31 19:00 blobs/sha256/69ef7069416ccbce7f36f36f117510a50326a0ad3a7ea4b30933dbb24e371fee
-rw-rw-rw- 0/0           23293 1969-12-31 19:00 blobs/sha256/04edff225a620c020349ce1da98939449f0f9a5603fbf5b81f771e399f85f6f1
-rw-rw-rw- 0/0        57540967 1969-12-31 19:00 blobs/sha256/3e634c55be4d41a450f3edf38415d792fd1006bb59260b3aca8a9799b0e67c8c
-rw-rw-rw- 0/0        50160606 1969-12-31 19:00 blobs/sha256/c8f00c165a37469a35f91571729cd5f319ce28b1d67c94233baeb99b1f133685
-rw-rw-rw- 0/0           11929 1969-12-31 19:00 blobs/sha256/481ee4744cbf54ceb21243ed5a424023a27cbfa9c4efe744fda2755cd7ccbb8f
-rw-rw-rw- 0/0            1227 1969-12-31 19:00 blobs/sha256/1bcf66605cd10e4a5c27dfb9c04dfa3c9d7e03e581f9620f352d978c28cba73d
-rw-rw-rw- 0/0            1915 1969-12-31 19:00 blobs/sha256/57350583fba19eaab4b4632aafa1537483a390dfd29c5b37c9d59e2467ce1b8e
-rw-rw-rw- 0/0            3224 1969-12-31 19:00 blobs/sha256/282bd1664cf1fccccf9f225118e31f9352f1f93e4d0ad485c92e74ec6b11ebd1
-rw-rw-rw- 0/0         3417974 1969-12-31 19:00 blobs/sha256/f54a5150a7602eaef3169b83e73d5927b20aef2fcaefcba18b532bd63b328fff
-rw-rw-rw- 0/0          295665 1969-12-31 19:00 blobs/sha256/b6afea20d55c46e60901e594cad0651da46b7437cf42a3c27e52d5bd37320165
-rw-rw-rw- 0/0         6403790 1969-12-31 19:00 blobs/sha256/c8f4e00e7d3c5ea061e25a18ba6127f79930efbbd3f3deb59c272ca0d6de23c3
-rw-rw-rw- 0/0             370 1969-12-31 19:00 blobs/sha256/665375f3730237f2109d398104a2072e38166ecf5d8316b1464f8a005146384e
-rw-rw-rw- 0/0             214 1969-12-31 19:00 blobs/sha256/9959184a302f6f95d8be97229fb31def6700b1895b1ee92090129b60e6567820
```

```sh
$ tar tvf 000002-tools.tar 
-rw-rw-rw- 0/0              30 1969-12-31 19:00 oci-layout
-rw-rw-rw- 0/0             580 1969-12-31 19:00 index.json
drwxrwxrwx 0/0               0 1969-12-31 19:00 blobs
drwxrwxrwx 0/0               0 1969-12-31 19:00 blobs/sha256
-rw-rw-rw- 0/0           11303 1969-12-31 19:00 blobs/sha256/43dc1c886da303b6a1b0ca67679565d560fc5e21cd70d69a5fca06daef5e004a
-rw-rw-rw- 0/0            2416 1969-12-31 19:00 blobs/sha256/8b10c3744b8fede79af784d967911691d0e2d6e505512d1466ae1dbcaf745033
-rw-rw-rw- 0/0            1914 1969-12-31 19:00 blobs/sha256/7b51768d110708c44179dc299884e9ee73d243a37abccce2dc796abc36371a38
-rw-rw-rw- 0/0            6533 1969-12-31 19:00 blobs/sha256/f1e21ce508b7f91169630895a0fe9a9f58288e5eb6e899c3462f168229c84193
-rw-rw-rw- 0/0         3402542 1969-12-31 19:00 blobs/sha256/619be1103602d98e1963557998c954c892b3872986c27365e9f651f5bc27cab8
-rw-rw-rw- 0/0          360570 1969-12-31 19:00 blobs/sha256/e88463a31d6d2c104349aaaaae3b5a60c2a63ba0ac2712ba190211e9cd15d4cc
-rw-rw-rw- 0/0            7452 1969-12-31 19:00 blobs/sha256/de93e10dd6701c976a78596c69babad750fc3957060c758b8859daab7fd2dd27
-rw-rw-rw- 0/0        14706390 1969-12-31 19:00 blobs/sha256/c9ae96b49a2d955ff25ddc1858d84596c16d525d531d2342bd372945ccf5e410
-rw-rw-rw- 0/0              32 1969-12-31 19:00 blobs/sha256/4f4fb700ef54461cfa02571ae0db9a0dc1e0cdb5577484a6d75e68dc38e8acc1
-rw-rw-rw- 0/0           11806 1969-12-31 19:00 index.json
```

### Batch-Serialize FAQ

#### What is the batch file?

The batch file is a csv-formatted file that contains the mirror artifacts that are to be serialized. It should be formatted accordingly:

```csv
name, artifact # header
tools, localhost:5000/gather:sources1 # artifact 1
ops, localhost:5000/gather:ops1 # artifact 2
```

#### Can the batch list be deleted?

Yes, the batch file is safe to delete and/or edit as needed. It is passed as an argument to the `ace-dt batch-serialize` command to define what artifacts need to be serialized and what the filename should be.

#### What is the tracker file?

The tracker file is a file typically named `SYNC-DIRECTORY/record-keeping.csv` that is generated by `ace-dt batch-serialize`. It keeps track of 3 things: the artifact reference, the artifact digest, and the file in which the artifact was serialized. Each entry in the batch file will create an individual tar/zst/gzip file in the SYNC-DIRECTORY, and they will be tracked in the trackerfile. When artifacts are added or upgraded to the batch file, `ace-dt batch-serialize` will look to the tracker file to see if there are any blobs in the new artifact(s) that already exist in previously serialized files. If so, `ace-dt` will skip serialization of that blob in the new file.

#### Can the tracker file be deleted?

Yes and no. Deleting the trackerfile will tell `ace-dt batch-serialize` that everything in the batch file needs to be re-serialized exactly. So if you have cleared your `SYNC-DIRECTORY` of all serialized files and need to regenerate them or completely create a new set of serialized artifacts, then the trackerfile can be deleted. However, if you have files in your `SYNC-DIRECTORY` and want to take advantage of the incremental serialization that `batch-serialize` provides, the `SYNC-DIRECTORY/record-keeping.csv` file should be retained and will be used accordingly by `ace-dt`.

#### What is the sync directory?

The sync directory is the directory in which you want all of the serialized files and the `SYNC-DIRECTORY/record-keeping.csv` to exist.

#### Can the sync directory be deleted?

If you no longer need the serialized files and no longer need to keep track of the state of previously serialized files, then yes.
